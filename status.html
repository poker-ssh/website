<!DOCTYPE html>
<html lang="en">

    <head>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@300..700&display=swap');
        </style>

        <link rel="stylesheet" href="static/css/style.css"/>
        <link rel="icon" type="image/x-icon" href="assets/favicon.png">
        <script src="static/js/script.js"></script>

        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Status | Poker over SSH</title>
    </head>

    <body>
        <div class="header">
            <div class="logo-section">
                <img src="assets/favicon.png" alt="Logo">
            </div>
            <div class="nav-section">
                <a href="index.html" class="button">HOME</a>
                <a href="guide.html" class="button">GUIDE</a>
                <a href="about.html" class="button">ABOUT</a>
                <a href="status.html" class="button base">STATUS</a>
                <!-- removed inline nav GitHub icon; site corner will be used instead -->
            </div>
        </div>

        <!-- GitHub corner (top-right) -->
        <a href="https://github.com/poker-ssh/Poker-over-SSH" class="site-github-corner" aria-label="View on GitHub" title="View on GitHub" target="_blank">
            <svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true">
                <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z" fill="#fff"></path>
                <path class="octo-arm" d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;"></path>
                <path class="octo-body" d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor"></path>
            </svg>
        </a>
            </div>
        </div>
        
        <h1>Status</h1>
        <h3>The status of the game server for Poker Over SSH</h3>
        
        <div id="server-status-container">
            <div id="server-status-display">
                <div class="status-loading">üîÑ Loading server status...</div>
            </div>
        </div>

        <script>
            // Dedicated status fetching function for this page
            async function loadServerStatus() {
                const statusDisplay = document.getElementById('server-status-display');
                if (!statusDisplay) return;

                try {
                    console.log('Fetching server status...');
                    
                    // Use the shared fetchWithTimeout helper (defined in static/js/script.js)
                    const response = await fetchWithTimeout('https://status.prod.poker.qincai.xyz/health', {
                        headers: { 'Accept': 'application/json' }
                    }, 10000);
                    
                    console.log('Response status:', response.status);
                    
                    // Check for server errors (5xx)
                    if (response.status >= 500) {
                        throw new Error(`Server Error ${response.status}: The status server is experiencing issues`);
                    }
                    
                    // Check for other HTTP errors (4xx, etc.)
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    
                    console.log('Status data received:', data);
                    
                    const isOnline = data.status === 'ok' && data.probe && data.probe.tcp_connect && data.probe.ssh_ok;
                    const lastProbeDate = new Date(data.last_probe * 1000);
                    const timeDiff = Date.now() - lastProbeDate.getTime();
                    const minutesAgo = Math.floor(timeDiff / (1000 * 60));
                    
                    let timeAgoText;
                    if (minutesAgo < 1) {
                        timeAgoText = 'Less than a minute ago';
                    } else if (minutesAgo < 60) {
                        timeAgoText = `${minutesAgo} minute${minutesAgo > 1 ? 's' : ''} ago`;
                    } else {
                        const hoursAgo = Math.floor(minutesAgo / 60);
                        timeAgoText = `${hoursAgo} hour${hoursAgo > 1 ? 's' : ''} ago`;
                    }

                    const statusHTML = `
                        <div style="background: rgba(38, 171, 69, 0.1); border: 1px solid rgba(38, 171, 69, 0.3); padding: 10px; margin-bottom: 20px; border-radius: 8px; text-align: center;">
                            <strong>üåê Live Status</strong> - Updated from API
                        </div>
                        
                        <div class="status-header">
                            <div class="status-indicator ${isOnline ? 'status-online' : 'status-offline'}">
                                ${isOnline ? 'üü¢ Server Online' : 'üî¥ Server Offline'}
                            </div>
                        </div>
                        
                        <div class="status-details">
                            <div class="status-item">
                                <div class="status-item-title">Overall Status</div>
                                <div class="status-item-value ${data.status === 'ok' ? 'success' : 'error'}">
                                    ${data.status === 'ok' ? '‚úÖ OK' : '‚ùå ' + data.status}
                                </div>
                            </div>
                            
                            <div class="status-item">
                                <div class="status-item-title">Last Health Check</div>
                                <div class="status-item-value">
                                    ${timeAgoText}
                                </div>
                            </div>
                            
                            <div class="status-item">
                                <div class="status-item-title">Server Host</div>
                                <div class="status-item-value">
                                    ${data.probe?.host || 'Unknown'}
                                </div>
                            </div>
                            
                            <div class="status-item">
                                <div class="status-item-title">Server Port</div>
                                <div class="status-item-value">
                                    ${data.probe?.port || 'Unknown'}
                                </div>
                            </div>
                            
                            <div class="status-item">
                                <div class="status-item-title">TCP Connection</div>
                                <div class="status-item-value ${data.probe?.tcp_connect ? 'success' : 'error'}">
                                    ${data.probe?.tcp_connect ? '‚úÖ Connected' : '‚ùå Failed'}
                                </div>
                            </div>
                            
                            <div class="status-item">
                                <div class="status-item-title">SSH Service</div>
                                <div class="status-item-value ${data.probe?.ssh_ok ? 'success' : 'error'}">
                                    ${data.probe?.ssh_ok ? '‚úÖ Available' : '‚ùå Unavailable'}
                                </div>
                            </div>
                            
                            ${data.probe?.error ? `
                            <div class="status-item" style="grid-column: 1 / -1;">
                                <div class="status-item-title">Error Details</div>
                                <div class="status-item-value error">
                                    ${data.probe.error}
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="status-timestamp">
                            Last updated: ${new Date().toLocaleString()}<br>
                            Health check: ${lastProbeDate.toLocaleString()}<br>
                            <a href="https://status.prod.poker.qincai.xyz/health" target="_blank" style="color: rgb(100, 200, 255); text-decoration: none;">View Raw API Data ‚Üí</a>
                        </div>
                    `;

                    statusDisplay.innerHTML = statusHTML;
                    
                } catch (error) {
                    console.error('Failed to fetch status:', error);
                    
                    // Check for different types of errors
                    const isTimeoutError = error.name === 'AbortError';
                    const isServerError = error.message.includes('Server Error 5');
                    const is502Error = error.message.includes('502') || error.message.includes('Bad Gateway');
                    const isCORSError = error.message.includes('CORS') || error.message.includes('fetch') || 
                                       error.message.includes('Failed to fetch');
                    
                    if (isTimeoutError) {
                        // Handle timeout errors
                        console.log('Timeout error detected - request took longer than 10 seconds');
                        statusDisplay.innerHTML = `
                            <div style="background: rgba(255, 165, 0, 0.1); border: 1px solid rgba(255, 165, 0, 0.3); padding: 15px; margin-bottom: 20px; border-radius: 8px; text-align: center;">
                                <strong>‚è±Ô∏è Request Timeout</strong><br>
                                <small>The status server took too long to respond (>10 seconds)</small>
                            </div>
                            
                            <div class="status-header">
                                <div class="status-indicator status-offline">
                                    üïê Server Slow/Unresponsive
                                </div>
                            </div>
                            
                            <div class="status-details">
                                <div class="status-item">
                                    <div class="status-item-title">Timeout Duration</div>
                                    <div class="status-item-value">
                                        10 seconds
                                    </div>
                                </div>
                                
                                <div class="status-item">
                                    <div class="status-item-title">Possible Causes</div>
                                    <div class="status-item-value">
                                        High server load or network issues
                                    </div>
                                </div>
                                
                                <div class="status-item">
                                    <div class="status-item-title">Manual Check</div>
                                    <div class="status-item-value">
                                        <a href="https://status.prod.poker.qincai.xyz/health" target="_blank" style="color: rgb(100, 200, 255); text-decoration: none;">
                                            Try Direct API Access ‚Üí
                                        </a>
                                    </div>
                                </div>
                                
                                <div class="status-item">
                                    <div class="status-item-title">SSH Test</div>
                                    <div class="status-item-value">
                                        ssh play.poker.qincai.xyz -p 23456
                                    </div>
                                </div>
                            </div>
                            
                            <div class="status-timestamp">
                                Timeout occurred: ${new Date().toLocaleString()}<br>
                                <small>The page will retry automatically in 30 seconds</small>
                            </div>
                        `;
                    } else if (is502Error) {
                        // Handle 502 Bad Gateway errors
                        statusDisplay.innerHTML = `
                            <div style="background: rgba(255, 140, 0, 0.1); border: 1px solid rgba(255, 140, 0, 0.3); padding: 15px; margin-bottom: 20px; border-radius: 8px; text-align: center;">
                                <strong>üö™ Bad Gateway (502)</strong><br>
                                <small>The status server proxy/gateway is experiencing issues</small>
                            </div>
                            
                            <div class="status-header">
                                <div class="status-indicator status-offline">
                                    üîÑ Gateway Error
                                </div>
                            </div>
                            
                            <div class="status-details">
                                <div class="status-item" style="grid-column: 1 / -1;">
                                    <div class="status-item-title">Error Type</div>
                                    <div class="status-item-value error">
                                        502 Bad Gateway - Proxy/Load Balancer Issue
                                    </div>
                                </div>
                                
                                <div class="status-item">
                                    <div class="status-item-title">Likely Cause</div>
                                    <div class="status-item-value">
                                        Backend server unreachable or overloaded
                                    </div>
                                </div>
                                
                                <div class="status-item">
                                    <div class="status-item-title">Game Server Status</div>
                                    <div class="status-item-value">
                                        Unknown (monitoring gateway down)
                                    </div>
                                </div>
                                
                                <div class="status-item">
                                    <div class="status-item-title">Direct SSH Test</div>
                                    <div class="status-item-value">
                                        ssh play.poker.qincai.xyz -p 23456
                                    </div>
                                </div>
                                
                                <div class="status-item" style="grid-column: 1 / -1;">
                                    <div class="status-item-title">Note</div>
                                    <div class="status-item-value">
                                        502 errors usually indicate the monitoring infrastructure is having issues, not necessarily the game server itself.<br>
                                        Try the SSH connection above to test the game server directly.
                                    </div>
                                </div>
                            </div>
                            
                            <div class="status-timestamp">
                                Gateway error detected: ${new Date().toLocaleString()}<br>
                                <small>Status monitoring will retry automatically</small>
                            </div>
                        `;
                    } else if (isServerError) {
                        // Handle 5xx server errors
                        statusDisplay.innerHTML = `
                            <div style="background: rgba(255, 100, 100, 0.1); border: 1px solid rgba(255, 100, 100, 0.3); padding: 15px; margin-bottom: 20px; border-radius: 8px; text-align: center;">
                                <strong>üî• Status Server Error</strong><br>
                                <small>The status monitoring server is experiencing internal issues</small>
                            </div>
                            
                            <div class="status-header">
                                <div class="status-indicator status-offline">
                                    üö® Status Server Down
                                </div>
                            </div>
                            
                            <div class="status-details">
                                <div class="status-item" style="grid-column: 1 / -1;">
                                    <div class="status-item-title">Server Error</div>
                                    <div class="status-item-value error">
                                        ${error.message}
                                    </div>
                                </div>
                                
                                <div class="status-item">
                                    <div class="status-item-title">Game Server Status</div>
                                    <div class="status-item-value">
                                        Unknown (monitoring down)
                                    </div>
                                </div>
                                
                                <div class="status-item">
                                    <div class="status-item-title">Direct Connection Test</div>
                                    <div class="status-item-value">
                                        ssh play.poker.qincai.xyz -p 23456
                                    </div>
                                </div>
                                
                                <div class="status-item" style="grid-column: 1 / -1;">
                                    <div class="status-item-title">Note</div>
                                    <div class="status-item-value">
                                        The game server may still be running even if status monitoring is down.<br>
                                        Try the SSH connection above to test directly.
                                    </div>
                                </div>
                            </div>
                            
                            <div class="status-timestamp">
                                Server error detected: ${new Date().toLocaleString()}<br>
                                <small>Status monitoring will retry automatically</small>
                            </div>
                        `;
                    } else if (isCORSError) {
                        // For CORS errors, try to get status via a different method
                        // Show a message explaining the situation and provide alternatives
                        statusDisplay.innerHTML = `
                            <div style="background: rgba(255, 165, 0, 0.1); border: 1px solid rgba(255, 165, 0, 0.3); padding: 15px; margin-bottom: 20px; border-radius: 8px; text-align: center;">
                                <strong>üîí Direct API Access Blocked</strong><br>
                                <small>Browser security policy prevents direct access to the status API from this website.<br>
                                Use the manual methods below to check the current server status.</small>
                            </div>
                            
                            <div class="status-header">
                                <div class="status-indicator status-offline">
                                    üîç Manual Check Required
                                </div>
                            </div>
                            
                            <div class="status-details">
                                <div class="status-item">
                                    <div class="status-item-title">Live API Status</div>
                                    <div class="status-item-value">
                                        <a href="https://status.prod.poker.qincai.xyz/health" target="_blank" style="color: rgb(100, 200, 255); text-decoration: none;">
                                            View Live Status JSON ‚Üí
                                        </a>
                                    </div>
                                </div>
                                
                                <div class="status-item">
                                    <div class="status-item-title">Server Host</div>
                                    <div class="status-item-value">
                                        play.poker.qincai.xyz
                                    </div>
                                </div>
                                
                                <div class="status-item">
                                    <div class="status-item-title">Server Port</div>
                                    <div class="status-item-value">
                                        23456
                                    </div>
                                </div>
                                
                                <div class="status-item">
                                    <div class="status-item-title">SSH Test Command</div>
                                    <div class="status-item-value">
                                        ssh play.poker.qincai.xyz -p 23456
                                    </div>
                                </div>
                                
                                <div class="status-item" style="grid-column: 1 / -1;">
                                    <div class="status-item-title">How to Check Status</div>
                                    <div class="status-item-value">
                                        1. Click the "View Live Status JSON" link above to see real-time data<br>
                                        2. Look for "status": "ok" and "ssh_ok": true in the JSON response<br>
                                        3. Or test the game server directly with the SSH command above
                                    </div>
                                </div>
                            </div>
                            
                            <div class="status-timestamp">
                                CORS blocked: ${new Date().toLocaleString()}<br>
                                <small>The API endpoint is working, but browser security prevents direct access from this page</small>
                            </div>
                        `;
                    } else {
                        // For other errors, show the original error display
                        statusDisplay.innerHTML = `
                            <div style="background: rgba(255, 100, 100, 0.1); border: 1px solid rgba(255, 100, 100, 0.3); padding: 10px; margin-bottom: 20px; border-radius: 8px; text-align: center;">
                                <strong>‚ö†Ô∏è API Connection Issue</strong><br>
                                <small>Unable to fetch live status data</small>
                            </div>
                            
                            <div class="status-header">
                                <div class="status-indicator status-offline">
                                    üî¥ Status Check Failed
                                </div>
                            </div>
                            
                            <div class="status-details">
                                <div class="status-item" style="grid-column: 1 / -1;">
                                    <div class="status-item-title">Error</div>
                                    <div class="status-item-value error">
                                        ${error.message}
                                    </div>
                                </div>
                                
                                <div class="status-item">
                                    <div class="status-item-title">Manual Check</div>
                                    <div class="status-item-value">
                                        <a href="https://status.prod.poker.qincai.xyz/health" target="_blank" style="color: rgb(100, 200, 255); text-decoration: none;">
                                            View Health Endpoint ‚Üí
                                        </a>
                                    </div>
                                </div>
                                
                                <div class="status-item">
                                    <div class="status-item-title">SSH Test Command</div>
                                    <div class="status-item-value">
                                        ssh play.poker.qincai.xyz -p 23456
                                    </div>
                                </div>
                            </div>
                            
                            <div class="status-timestamp">
                                Last attempt: ${new Date().toLocaleString()}
                            </div>
                        `;
                    }
                }
            }

            // Initialize when page loads
            document.addEventListener('DOMContentLoaded', loadServerStatus);
            window.addEventListener('load', loadServerStatus);
            
            // Auto-refresh every 30 seconds
            setInterval(loadServerStatus, 30000);
        </script>
    </body>
</html>